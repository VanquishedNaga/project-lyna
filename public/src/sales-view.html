<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html">
<link rel="import" href="shared-styles.html">

<script src="../bower_components/firebase/firebase-functions.js"></script>
<script src="../bower_components/strftime/strftime-min.js"></script>

<dom-module id="sales-view">
  <template>
    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="sales"
      app-name="absolute-reborn"
      path="/sales">
    </firebase-document>

    <firebase-document
      id="product-lists"
      path = "/products"
      data = "{{productsList}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="inventoryData"
      app-name="absolute-reborn"
      path="/users/[[user.uid]]/inventory"
      data="{{inventoryList}}">
    </firebase-query>

    <firebase-query
      id="sales"
      app-name="absolute-reborn"
      path="/sales"
      order-by-child="seller"
      equal-to="[[user.uid]]"
      data="{{sales}}">
    </firebase-query>

    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

    <!-- Visible contents -->
    <app-header-layout>
      <app-header slot="header" condenses shadow fixed>
        <app-toolbar class="header">
          <slot name="drawer-toggle"></slot>
          <div>Sales</div>
        </app-toolbar>
        <app-toolbar class="tabs-bar" sticky>
          <paper-button class="custom" on-tap="placeOrder">
            <iron-icon icon="credit-card"></iron-icon>
            <span>Place an order</span>
          </paper-button>
        </app-toolbar>
      </app-header>
      <div class="content">
        <paper-listbox id="salesList" class="custom" attr-for-selected="key">
          <template is="dom-repeat" items="{{sales}}">
            <paper-icon-item key="[[item.$key]]">
              <paper-item-body two-line style="width: 30%;">
                <div>[[getProdName(productsList.*, item.prod)]]</div>
                <div secondary>[[item.qty]]</div>
              </paper-item-body>
              <paper-item-body two-line style="width: 30%;">
                <div>[[item.custname]]</div>
                <div secondary>[[item.custaddr]]</div>
              </paper-item-body>
              <div style="width: 20%;">[[item.stat]]</div>
              <paper-item-body two-line style="width: 20%;">
                <div>[[_formatEpochDate(item.time)]]</div>
                <div secondary>[[_formatEpochTime(item.time)]]</div>
              </paper-item-body>

              <paper-icon-button icon="check" alt="Accept" on-tap="openApproveSalesDialog">
              </paper-icon-button>
              <paper-icon-button icon="clear" alt="Reject" on-tap="openRejectSalesDialog">
              </paper-icon-button>

            </paper-icon-item>
          </template>
        </paper-listbox>
      </div>
    </app-header-layout>

    <!-- To place a sales order -->
    <paper-dialog id="placeOrder" on-iron-overlay-closed="onPlaceOrderClosed" modal>
      <h2>Sales Order</h2>

      <paper-input
        id="custName"
        label="Customer Name"
        error-message="Field required!"
        always-float-label required auto-validate>
      </paper-input>

      <paper-input
        id="custAddr"
        label="Delivery Address"
        error-message="Field required!"
        always-float-label required auto-validate>
      </paper-input>

      <paper-dropdown-menu label="Select product" id="prodMenu" required error-message="Field required!">
        <paper-listbox id="prodList" slot="dropdown-content" attr-for-selected="key" selected="{{prodKey}}">
          <template is="dom-repeat" items="{{inventoryList}}">
            <paper-item key="[[item.$key]]">[[getProdName(productsList.*, item.$key)]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>

      <paper-input always-float-label required auto-validate
        type="number"
        min="1"
        error-message="Field required!"
        id="prodQuan"
        label="Product Quantity"
        style="display: inline-block;">
      </paper-input>

      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button autofocus on-tap="submitOrder">Confirm</paper-button>
      </div>
    </paper-dialog>

    <!-- To confirm accepting a sales request -->
    <paper-dialog id="approveSalesDialog" on-iron-overlay-closed="onApproveSalesDialogClosed" modal>
      <h2>Mark Order as Processed</h2>
      <p>Are you sure you want to mark this order as processed?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>

    <!-- To confirm rejecting a sales request -->
    <paper-dialog id="rejectSalesDialog" on-iron-overlay-closed="onRejectSalesDialogClosed" modal>
      <h2>Mark Order as Rejected</h2>
      <p>Are you sure you want to mark this order as rejected?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="actionFailedToast" text="You can't perform this action!"> </paper-toast>

  </template>

  <script>
    class SalesView extends Polymer.Element {
      static get is() { return 'sales-view'; }
      static get properties() {
        return {
          inventoryList: Array,
          productsList: Array,
          sales: Array,
          user: Object,
          userdata: Object,
          salesOrder: {
            type: Object,
            value: new Object(),
          }
        };
      }

      static get observers() {
        return [
          'userPrivChanged(userdata.privilege)'
        ]
      }

      ready() {
        super.ready();
        console.log("SalesView ready.");
      }

      userPrivChanged(priv) {
        if (priv == 'Admin') {
          this.$.sales.orderByChild = null;
          this.$.sales.equalTo = null;
        }
        else {
          this.$.sales.orderByChild = 'seller';
          this.$.sales.equalTo = this.user.uid;
        }
      }

      openApproveSalesDialog(e) {
        if (e.model.__data.item.stat == 'Processing') {
          this.salesOrder.key = e.model.__data.item.$key;
          Polymer.dom(document.body).appendChild(this.$.approveSalesDialog);
          this.$.approveSalesDialog.open();
        }
        else {
          Polymer.dom(document.body).appendChild(this.$.actionFailedToast);
          this.$.actionFailedToast.center();
          this.$.actionFailedToast.refit();
          this.$.actionFailedToast.open();
        }
      }

      onApproveSalesDialogClosed(event) {
        if (this.$.approveSalesDialog.closingReason.confirmed) {
          var processSales = firebase.app('absolute-reborn').functions().httpsCallable('processSales');
          processSales({
            key: this.salesOrder.key,
            action: 'Processed',
          }).then(function(result) {
          }).catch((err) => {
          });
        }
        Polymer.dom(document.body).removeChild(this.$.approveSalesDialog);
        this.salesOrder.key = null;
      }

      openRejectSalesDialog(e) {
        if (e.model.__data.item.stat == 'Processing') {
          this.salesOrder.key = e.model.__data.item.$key;
          Polymer.dom(document.body).appendChild(this.$.rejectSalesDialog);
          this.$.rejectSalesDialog.open();
        }
        else {
          Polymer.dom(document.body).appendChild(this.$.actionFailedToast);
          this.$.actionFailedToast.open();
        }
      }

      onRejectSalesDialogClosed(event) {
        if (this.$.rejectSalesDialog.closingReason.confirmed) {
          var processSales = firebase.app('absolute-reborn').functions().httpsCallable('processSales');
          processSales({
            key: this.salesOrder.key,
            action: 'Rejected',
          }).then(function(result) {
          }).catch((err) => {
          });
        }
        Polymer.dom(document.body).removeChild(this.$.rejectSalesDialog);
        this.salesOrder.key = null;
      }

      placeOrder() {
        Polymer.dom(document.body).appendChild(this.$.placeOrder);
        this.$.placeOrder.open();
      }

      submitOrder() {
        // Check all inputs are valid, add new fields here.
        var valid = this.$.custName.validate();
        valid = this.$.custAddr.validate() && valid;
        valid = this.$.prodMenu.validate() && valid;
        valid = this.$.prodQuan.validate() && valid;

        if (valid) {
          var addSales = firebase.app('absolute-reborn').functions().httpsCallable('addSales');
          addSales({
            custname: this.$.custName.value,
            custaddr: this.$.custAddr.value,
            prod: this.$.prodList.selected,
            qty: this.$.prodQuan.value,
            time: {".sv":"timestamp"},
            seller: this.user.uid,
            stat: "Processing",
          }).then(function(result) {
          }).catch((err) => {
          });

          this.$.placeOrder.close();
        }
      }

      onPlaceOrderClosed(event) {
        // To prevent paper-dropdown-menu from closing paper-dialog.
        if (event.target == this.$.placeOrder) {
          // Reset all fields.
          this.$.custName.value = null;
          this.$.custName.invalid = false;
          this.$.custAddr.value = null;
          this.$.custAddr.invalid = false;
          this.$.prodMenu.value = null;
          this.$.prodMenu.invalid = false;
          this.$.prodQuan.value = null;
          this.$.prodQuan.invalid = false;
          this.$.prodList.selected = null;

          Polymer.dom(document.body).removeChild(this.$.placeOrder);
        }
      }

      getProdName(change, prod) {
        if (change.base[prod] != undefined){
          return change.base[prod]['name'];
        }
      }

      _formatEpochDate(eTS) {
        return strftime('%D', new Date(eTS));
      }

      _formatEpochTime(eTS) {
        return strftime('%I:%M %P', new Date(eTS));
      }
    }

    window.customElements.define(SalesView.is, SalesView);
  </script>
</dom-module>
