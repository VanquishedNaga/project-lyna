<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">

<dom-module id="store-view">
  <template>
    <firebase-auth
      id="auth"
      app-name="absolute-reborn"
      provider="google"
      signed-in="{{signedIn}}"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="absolute-reborn"
      path="/products"
      data="{{prodItems}}">
    </firebase-query>

    <firebase-storage-ref
      id="storage"
      app-name="absolute-reborn"
      path="/products"
      metadata="{{metadata}}"
      storage-uri="{{gsUri}}"
      download-url="{{downloadUrl}}"
      force-unique>
    </firebase-storage-ref>

    <firebase-storage-upload-task
      id="task"
      app-name="absolute-reborn"
      task="[[task]]"
      bytes-transferred="{{bytesTransferred}}"
      total-bytes="{{totalBytes}}"
      state="{{state}}"
      download-url="{{downloadUrl}}"
      metadata="{{metadata}}"
      path="{{path}}">
    </firebase-storage-upload-task>

    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .product-card {
        /*background: linear-gradient(white, #b2ebf2);*/
        background: #b2ebf2;
        --paper-card-header-color: white;
        --paper-card-header: {
          background-color: var(--paper-blue-500);
        };
        --paper-card-actions: {
          background-color: var(--paper-purple-500);
        };
      }
    </style>

    <app-toolbar class="tabs-bar" hidden$="{{!wideLayout}}">
      <paper-tabs selected="{{selected}}" attr-for-selected="name">
        <template is="dom-repeat" items="{{tabItems}}">
          <paper-tab name$="{{item}}">{{item}}</paper-tab>
        </template>
      </paper-tabs>
    </app-toolbar>

    <iron-pages selected="{{selected}}" attr-for-selected="page-name">
      <div page-name="Product">

        <app-toolbar hidden$="{{!wideLayout}}">
          <paper-button on-tap="addProduct" disabled="[[disabled]]">
            <iron-icon icon="add-circle-outline"></iron-icon>
            <span>Add product</span>
          </paper-button>
        </app-toolbar>

        <template is="dom-repeat" items="{{prodItems}}">
          <paper-card
            class="product-card"
            heading="[[item.name]]">
            <!-- style="width: 100%;" -->
            <div class="card-content">
              <div>
                <iron-image
                  src="[[item.images.downloadUrl]]"
                  style="
                    width:200px;
                    height:200px;
                    margin-left: auto;
                    margin-right: auto;
                    display: block;"
                  sizing="contain">
                </iron-image>
              </div>
              <h4>Description: </h4>
              <p>[[item.description]]</p>
            </div>
            <div class="card-actions">
              <paper-button on-tap="restock">Restock</paper-button>
              <paper-button on-tap="editProd">Edit</paper-button>
              <paper-button on-tap="delProd">Delete</paper-button>
            </div>
          </paper-card>

        </template>
      </div>
      <div page-name="Inventory">Page 2</div>
      <div>Page 3</div>
    </iron-pages>

    <!-- Dialog to add new product -->
    <paper-dialog
      id="addprod"
      on-iron-overlay-closed="closeThis">
      <h2>Add product</h2>
      <paper-input always-float-label required
        error-message="Field required!"
        id="new-prod-name"
        label="Product Name">
      </paper-input>
      <paper-textarea always-float-label id="new-prod-desc" label="Product Description"></paper-textarea>
      <div class="buttons">
        <paper-input type="file" id="prod-pic" accept="image/jpeg"></paper-input>
        <!-- <paper-button on-tap="uploadProdPic" >Upload photo</paper-button> -->
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="saveNewProd" autofocus>Save</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class StoreView extends Polymer.Element {
      static get is() { return 'store-view'; }
      static get properties() {
        return {
          productName: String,

          selected: {type: String, value: 'Product'},

          tabItems: {
            type: Array,
            value: function() {
              return ['Product', 'Inventory'];
            }
          },

          prodItems: {
            type: Array
          },

          state: {
            type: Object,
            observer: 'stateChanged'
          }
        };
      }

      ready() {
        super.ready();
        console.log("StoreView ready.");

        this.dlAddProduct = this.shadowRoot.querySelector('#addprod');
        this.prodName = this.shadowRoot.querySelector('#new-prod-name');
        this.prodDesc = this.shadowRoot.querySelector('#new-prod-desc');
        this.prodPic = this.shadowRoot.querySelector('#prod-pic');

        // init to null to solve error
        this.prodKey = null;
        this.prodName.value = null;
        this.prodDesc.value = null;
      }

      addProduct() {
        Polymer.dom(document.body).appendChild(this.dlAddProduct);

        this.dlAddProduct.toggle();
        this.dlAddProduct.constrain();
      }

      closeThis() {
        //Polymer.dom(document.body).removeChild(this.dlAddProduct);
        this.prodName.value = null;
        this.prodDesc.value = null;
        this.prodName.invalid = false;
        this.prodPic.value = null;
      }

      saveNewProd() {
        var valid = this.prodName.validate();

        if (valid)
        {
          if (this.prodKey){
            this.$.doc.path = '/products/' + this.prodKey;
            this.$.doc.ref.update({
              name: this.prodName.value,
              description: this.prodDesc.value
            });
            console.log(this.prodName.value + ' edited.');
          }
          else{
            this.$.doc.path = '/products';

            // Save the key.
            this.prodKey = this.$.doc.ref.push({
              name: this.prodName.value,
              description: this.prodDesc.value,
            }).key;
            console.log(this.prodName.value + ' saved.');
            console.log('Key: ' + this.prodKey);
          }

          // Upload product pic.
          var file = this.prodPic.inputElement.inputElement.files[0];
          if (file){
            this.$.storage.path = '/products';
            this.$.task.task = this.$.storage.put(this.prodPic.inputElement.inputElement.files[0]);
          }
          else{
            this.prodKey = null;
          }

          // Close the dialog.
          this.dlAddProduct.close();
        }
      }

      delProd(e) {
        this.$.doc.path = '/products/'+ e.model.item.$key;

        if (e.model.item.images != null){
          // Delete product images.
          this.$.storage.path = '/' + e.model.item.images.path;
          this.$.storage.ref.delete();
        }

        // Remove product entry.
        this.$.doc.ref.remove();
        console.log(e.model.item.name + ' deleted from database.');
      }

      editProd(e) {
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.prodDesc.value = e.model.item.description || null;
        this.addProduct();
      }

      uploadProdPic() {
      }

      stateChanged() {
        console.log(this.$.task.state);
        if (this.$.task.state == 'success'){
          console.log(this.$.task.downloadUrl);
          console.log(this.$.task.path);

          // Add image path to product entry.
          this.$.doc.path = '/products/' + this.prodKey + '/images';
          this.$.doc.ref.set({
            path: this.$.task.path,
            downloadUrl: this.$.task.downloadUrl,
          });

          this.prodKey = null;
        }
      }
    }

    window.customElements.define(StoreView.is, StoreView);
  </script>
</dom-module>
