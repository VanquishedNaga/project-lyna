<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">

<dom-module id="store-view">
  <template>
    <firebase-auth
      id="auth"
      app-name="absolute-reborn"
      provider="google"
      signed-in="{{signedIn}}"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="absolute-reborn"
      path="/products"
      data="{{prodItems}}">
    </firebase-query>

    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <app-toolbar class="tabs-bar" hidden$="{{!wideLayout}}">
      <paper-tabs selected="{{selected}}" attr-for-selected="name">
        <template is="dom-repeat" items="{{tabItems}}">
          <paper-tab name$="{{item}}">{{item}}</paper-tab>
        </template>
      </paper-tabs>
    </app-toolbar>

    <iron-pages selected="{{selected}}" attr-for-selected="page-name">
      <div page-name="Product">
        <paper-button on-tap="addProduct" disabled="[[disabled]]">
          <iron-icon icon="add-circle-outline"></iron-icon>
          <span>Add product</span>
        </paper-button>
        <template is="dom-repeat" items="{{prodItems}}">
          <div class="card">
            <h1>[[item.name]]</h1>
            <p>Description: </p>
            <p>[[item.description]]</p>
            <div class="buttons">
              <paper-button on-tap="editProd">Edit</paper-button>
              <paper-button on-tap="delProd">Delete</paper-button>
            </div>
          </div>
        </template>
      </div>
      <div page-name="Inventory">Page 2</div>
      <div>Page 3</div>
    </iron-pages>

    <!-- Dialog to add new product -->
    <paper-dialog
      id="addprod"
      on-iron-overlay-closed="closeThis">
      <form is="iron-form" action="" id="new-prod-form">
        <h2>Add product</h2>
        <paper-input always-float-label required
          error-message="Field required!"
          id="new-prod-name"
          label="Product Name">
        </paper-input>
        <paper-textarea always-float-label id="new-prod-desc" label="Product Description"></paper-textarea>
        <div class="buttons">
          <paper-button>Upload photo</paper-button>
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button on-tap="saveNewProd" autofocus>Save</paper-button>
        </div>
      </form>
    </paper-dialog>

  </template>

  <script>
    class StoreView extends Polymer.Element {
      static get is() { return 'store-view'; }
      static get properties() {
        return {
          productName: String,
          
          selected: {type: String, value: 'Product'},

          tabItems: {
            type: Array,
            value: function() {
              return ['Product', 'Inventory'];
            }
          },

          prodItems: {
            type: Array
          }
        };
      }

      ready() {
        super.ready();
        console.log("StoreView ready.");

        this.dlAddProduct = this.shadowRoot.querySelector('#addprod');
        this.prodName = this.shadowRoot.querySelector('#new-prod-name');
        this.prodDesc = this.shadowRoot.querySelector('#new-prod-desc');
        this.newProdForm = this.shadowRoot.querySelector('#new-prod-form');

        // init to null to solve error
        this.prodKey = null;
        this.prodName.value = null;
        this.prodDesc.value = null;
      }

      addProduct() {
        Polymer.dom(document.body).appendChild(this.dlAddProduct);

        this.dlAddProduct.toggle();
        this.dlAddProduct.constrain();
      }

      closeThis() {
        //Polymer.dom(document.body).removeChild(this.dlAddProduct);
        this.prodName.value = null;
        this.prodDesc.value = null;
        this.prodName.invalid = false;
      }

      saveNewProd() {
        var valid = this.prodName.validate();
        if (valid)
        {
          if (this.prodKey){
            this.$.doc.path = '/products/' + this.prodKey;
            this.$.doc.ref.set({
              name: this.prodName.value,
              description: this.prodDesc.value
            });
            this.prodKey = null;
            console.log(this.prodName.value + ' edited.');
          }
          else{
            this.$.doc.path = '/products';
            this.$.doc.ref.push({
              name: this.prodName.value,
              description: this.prodDesc.value
            });
            console.log(this.prodName.value + ' saved.');
          }
          this.dlAddProduct.close();
        }
      }

      delProd(e) {
        this.$.doc.path = '/products/'+ e.model.item.$key;
        this.$.doc.ref.remove();
        console.log(e.model.item.name + ' deleted from database.');
      }

      editProd(e) {
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.prodDesc.value = e.model.item.description || null;
        this.addProduct();
      }
    }

    window.customElements.define(StoreView.is, StoreView);
  </script>
</dom-module>
