<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Condensed">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="inventory-view.html">
<link rel="import" href="request-view.html">

<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

<dom-module id="store-view">
  <template>
    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="upline"
      path = "/users/[[uplineUid]]"
      data = "{{uplineUserdata}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="product"
      path = "/products"
      data = "{{productsData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="stock"
      path = "/users/[[user.uid]]/inventory"
      data = "{{stockData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="absolute-reborn"
      path="/products"
      data="{{prodItems}}">
    </firebase-query>

    <firebase-query
      id="products-list"
      app-name="absolute-reborn"
      path="/products"
      data="{{productsList}}">
    </firebase-query>

    <firebase-storage-ref
      id="storage"
      app-name="absolute-reborn"
      path="/products"
      metadata="{{metadata}}"
      storage-uri="{{gsUri}}"
      download-url="{{downloadUrl}}"
      force-unique>
    </firebase-storage-ref>

    <firebase-storage-upload-task
      id="task"
      app-name="absolute-reborn"
      task="[[task]]"
      bytes-transferred="{{bytesTransferred}}"
      total-bytes="{{totalBytes}}"
      state="{{state}}"
      download-url="{{downloadUrl}}"
      metadata="{{metadata}}"
      path="{{path}}">
    </firebase-storage-upload-task>

    <firebase-storage-upload-task
      id="payProofTask"
      app-name="absolute-reborn"
      on-state-changed="onPayProofTaskStateChanged">
    </firebase-storage-upload-task>

    <style include="shared-styles">
      :host {
        display: block;
      }

      .prod-card {
        width: 80%;
        min-width: 282px;
        margin: 16px;
        font-family: 'Roboto Condensed', sans-serif;
        margin-left: auto;
        margin-right: auto;
      }

      .prod-header {
        background-color: var(--app-primary-color);
        color: white;
        display: flex;
        flex-wrap: wrap;
      }

      span.header {
        padding: 8px;
        font-size: 1.1em;
      }

      .prod-desc {
        overflow: auto;
      }

      .prod-content {
        clear: right;
        display: flex;
        flex-wrap: wrap;
      }

      .prod-info {
        min-width: 250px;
        word-break: break-word;
        hyphens: manual;
        vertical-align: top;
        margin: 16px;
        max-height: 250px;
        display: flex;
        flex-direction: column;
        flex: 1 1 250px;
      }

      .prod-act {
        float: right;
        margin-left: auto;
      }

      img{
        width: 250px;
        height: 250px;
        background-repeat: no-repeat;
        object-fit: cover;
        background-color: white;
        background-size: cover;
        margin: 16px;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      @media only screen and (max-width: 600px) {
        #productImage {
          min-width:150px;
        }
      }
    </style>

    <app-header-layout>
      <app-header slot="header" condenses shadow fixed effect="waterfall">
        <app-toolbar class="header">
          <slot name="drawer-toggle"></slot>
          <div>Store</div>
        </app-toolbar>
        <app-toolbar class="tabs-bar" hidden$="{{!wideLayout}}" sticky>
          <paper-tabs id="tabs" selected="{{selected}}" attr-for-selected="name">
            <template is="dom-repeat" items="{{tabItems}}">
              <paper-tab name$="{{item}}">{{item}}</paper-tab>
            </template>
          </paper-tabs>
        </app-toolbar>
      </app-header>

      <iron-pages selected="{{selected}}" attr-for-selected="page-name">
        <div page-name="Product">
          <template is="dom-if" if="[[isAdmin(userdata.privilege)]]">
            <app-toolbar>
              <paper-button on-tap="addProduct" class="custom">
                <iron-icon icon="add-circle-outline"></iron-icon>
                <span>Add product</span>
              </paper-button>
            </app-toolbar>
          </template>

          <template is="dom-repeat" items="{{prodItems}}">
            <paper-card class="prod-card horizontal">
              <div style="width: 100%;">
                <div class="prod-header">
                  <span class="header">[[item.name]]</span>
                  <div class="prod-act">
                    <paper-icon-button icon="icons:add-circle" on-tap="restock"></paper-icon-button>
                    <template is="dom-if" if="[[isAdmin(userdata.privilege)]]">
                      <paper-icon-button icon="icons:input" on-tap="adminRestock"></paper-icon-button>
                      <paper-icon-button icon="icons:create" on-tap="editProd"></paper-icon-button>
                      <paper-icon-button icon="icons:delete" on-tap="delProd"></paper-icon-button>
                    </template>
                  </div>
                </div>
                <div class="prod-content">
                  <img src="[[item.images.downloadUrl]]" alt="productPic"
                    onerror="this.src='../images/AR.png'"
                    onload="this.style.display='block'"/>
                  <div class="card-content prod-info">
                    <span style="font-weight: bold;">Description: </span>
                    <div class="prod-desc">[[item.description]]</div>
                  </div>
                </div>
              </div>
          </paper-card>
        </template>

        <paper-dialog id="delProdDialog" modal>
          <p>Are you sure you want to delete this product?</p>
          <div class="buttons">
            <paper-button dialog-dismiss>No</paper-button>
            <paper-button autofocus on-tap="deleteProduct">Yes
            </paper-button>
          </div>
        </paper-dialog>
      </div>
      <inventory-view
        user="[[user]]"
        page-name="Inventory">
      </inventory-view>
      <request-view
        user="[[user]]"
        userdata="[[userdata]]"
        page-name="Request">
      </request-view>
    </iron-pages>
  </app-header-layout>

    <!-- Dialog to add new product -->
    <paper-dialog
      id="dlAddProd"
      modal
      on-iron-overlay-closed="onDialogClosed">
      <h2>Add product</h2>
      <paper-input always-float-label required
        error-message="Field required!"
        id="new-prod-name"
        label="Product Name">
      </paper-input>
      <paper-dialog-scrollable>
        <paper-textarea always-float-label id="new-prod-desc" label="Product Description" value={{value}}></paper-textarea>
      </paper-dialog-scrollable>
      <paper-input type="file" id="prod-pic" accept="image/jpeg"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="saveNewProd" autofocus>Save</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="dlRestockProd" on-iron-overlay-closed="onDialogClosed" modal>
      <h2>Restock Request</h2>
      <paper-dialog-scrollable>
        <p>You are requesting restock from <b>[[uplineUserdata.name]]</b>.</p>
        <p>You have: [[getInventoryQuantity(prodKey)]]</p>
        <paper-dropdown-menu label="Select product" id="productMenu">
          <paper-listbox id="productList" slot="dropdown-content" attr-for-selected="key" selected="{{prodKey}}">
            <template is="dom-repeat" items="{{productsList}}">
              <paper-item key="[[item.$key]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-input always-float-label
          required
          error-message="Field required!"
          type="number"
          min="1"
          value="{{quantity}}"
          id="prod-quantity"
          label="Product Quantity">
        </paper-input>
        <p>Unit price: RM[[getPrices(productsData.*, prodKey, userdata.level)]] </p>
        <p>Total payable: RM[[getPayable(productsData.*, prodKey, userdata.level, quantity)]] </p>
        <paper-input type="file" id="payProof" accept="image/jpeg" label="Upload payment proof"></paper-input>
        </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="submitProdRequest">Submit Request</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="adminRestockDialog" on-iron-overlay-closed="onAdminRestockDialogClosed" modal>
      <h2>Admin Restock</h2>
      <paper-dropdown-menu label="Select product" id="productMenu">
        <paper-listbox id="productList" slot="dropdown-content" attr-for-selected="key" selected="{{prodKey}}">
          <template is="dom-repeat" items="{{productsList}}">
            <paper-item key="[[item.$key]]">[[item.name]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <p>Total in store: [[getTotalQuantity(prodKey)]]</p>
      <p>Unallocated: [[getFreeQuantity(prodKey)]]</p>
      <paper-input
        id="adminRestockQty"
        always-float-label
        required
        type="number"
        error-message="Field required!"
        id="prod-quantity"
        label="Product Quantity">
      </paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Submit</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="successToast" class="good" text="Action successful!"> </paper-toast>
    <paper-toast id="failToast" class="bad" text="Action failed! Please try again."> </paper-toast>

  </template>

  <script>
    class StoreView extends Polymer.Element {
      static get is() { return 'store-view'; }
      static get properties() {
        return {
          user: Object,
          productName: String,
          userdata: Object,
          uplineUserdata: Object,
          productsData: Object,
          productsList: Array,
          stockData: Object,
          selected: {type: String, value: 'Product'},
          prodKey: String,
          reqKey: String,
          tabItems: {
            type: Array,
            value: function() {
              return ['Product', 'Inventory', 'Request'];
            }
          },

          prodItems: {
            type: Array
          },

          state: {
            type: Object,
            observer: 'onUploadTaskStateChanged'
          },

          value: {
            type: Object,
            observer: 'valueChanged'
          },
        };
      }

      ready() {
        super.ready();
        console.log("StoreView ready.");

        this.prodName = this.shadowRoot.querySelector('#new-prod-name');
        this.prodDesc = this.shadowRoot.querySelector('#new-prod-desc');
        this.prodPic = this.shadowRoot.querySelector('#prod-pic');
        this.prodQuan = this.shadowRoot.querySelector('#prod-quantity');
        this.pages = this.shadowRoot.querySelector('#iron-pages');

        // init to null to solve error
        this.prodKey = null;
        this.prodName.value = null;
        this.prodDesc.value = null;
        this.prodQuan.value = null;
      }

      valueChanged() {
        this.$.dlAddProd.notifyResize();
      }

      addProduct() {
        Polymer.dom(document.body).appendChild(this.$.dlAddProd);

        this.$.dlAddProd.open();
      }

      restockProd(){
        Polymer.dom(document.body).appendChild(this.$.dlRestockProd);

        this.$.dlRestockProd.open();
      }

      onDialogClosed(event) {
        if (event.target == this.$.dlRestockProd) {
          this.prodName.value = null;
          this.prodDesc.value = null;
          this.prodName.invalid = false;
          this.prodPic.value = null;
          this.prodQuan.value = null;

          Polymer.dom(document.body).removeChild(this.$.dlRestockProd);
        }
      }

      saveNewProd() {
        var valid = this.prodName.validate();

        if (valid)
        {
          if (this.prodKey){
            this.$.doc.path = '/products/' + this.prodKey;
            this.$.doc.ref.update({
              name: this.prodName.value,
              description: this.prodDesc.value
            });
          }
          else{
            this.$.doc.path = '/products';

            // Save the key.
            this.prodKey = this.$.doc.ref.push({
              name: this.prodName.value,
              description: this.prodDesc.value,
            }).key;
          }

          // Upload product pic.
          var file = this.prodPic.inputElement.inputElement.files[0];
          if (file){
            this.$.storage.path = '/products';
            this.$.task.x = this.$.storage.put(this.prodPic.inputElement.inputElement.files[0]);
          }
          else{
            this.prodKey = null;
          }

          // Close the dialog.
          this.$.dlAddProd.close();
        }
      }

      delProd(e) {
        this.prodKey = e.model.item.$key;
        Polymer.dom(document.body).appendChild(this.$.delProdDialog);
        this.$.delProdDialog.open();
      }

      deleteProduct() {
        var path;
        this.$.doc.path = '/products/'+ this.prodKey;
        this.$.doc.ref.once("value")
         .then(function(snapshot) {
            if (this.$.doc.data['images'] != undefined) {
              path = this.$.doc.data['images']['path'];
              this.$.storage.path = '/' + path;
              this.$.storage.ref.delete();
            }
            this.$.doc.ref.remove();
            this.promptToast(this.$.successToast);
            this.prodKey = null;
          }.bind(this))
         .catch(function(error){
            this.promptToast(this.$.failToast);
          });

        this.$.delProdDialog.close();
        Polymer.dom(document.body).removeChild(this.$.delProdDialog);
      }

      editProd(e) {
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.prodDesc.value = e.model.item.description || null;
        this.addProduct();
      }

      restock(e){
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.uplineUid = this.userdata.upline;
        this.restockProd();
      }

      adminRestock(e){
        // Setup.
        this.prodKey = e.model.item.$key;

        // Open dialog.
        Polymer.dom(document.body).appendChild(this.$.adminRestockDialog);
        this.$.adminRestockDialog.open();
      }

      onAdminRestockDialogClosed(event) {
        if (event.target == this.$.adminRestockDialog) {
          if (this.$.adminRestockDialog.closingReason.confirmed) {
            var processSales = firebase.app('absolute-reborn').functions().httpsCallable('adminRestockFunction');
            processSales({
              prodKey: this.prodKey,
              qty: this.$.adminRestockQty.value,
            }).then(function(result) {
              this.promptToast(this.$.successToast);
            }.bind(this)).catch((err) => {
              this.promptToast(this.$.failToast);
            });
          }
          this.prodKey = null;
          this.$.adminRestockQty.value = null;
          Polymer.dom(document.body).removeChild(this.$.adminRestockDialog);
        }
      }

      onUploadTaskStateChanged() {
        if (this.$.task.state == 'success'){
          this.$.task.ref.getDownloadURL()
            .then(function(url){
              this.downloadUrl = url;
              // Add image path to product entry.
              this.$.doc.path = '/products/' + this.prodKey + '/images';
              this.$.doc.ref.set({
                path: this.$.task.path,
                downloadUrl: this.downloadUrl,
              });
              this.prodKey = null;
            }.bind(this));
        }
      }

      submitProdRequest(){
        var valid = this.prodQuan.validate();

        if (valid){
          if (this.prodKey){
            // Upload product pic.
            var file = this.$.payProof.inputElement.inputElement.files[0];
            if (file){
              this.$.storage.path = '/payProof';
              this.$.payProofTask.task = this.$.storage.put(file);
            }

            this.$.doc.path = '/productRequests';
            this.reqKey = this.$.doc.ref.push({
              productID: this.prodKey,
              quantity: this.prodQuan.value,
              requestor: this.user.uid,
              upline: this.uplineUid,
              status: "Pending",
              time: {".sv":"timestamp"}
            }).key;

            this.$.dlRestockProd.close();
          }
        }
      }

      onPayProofTaskStateChanged(event) {
        if (event.detail.value == 'success' && this.reqKey){
          this.$.payProofTask.ref.getDownloadURL().then(function(url){
            this.$.doc.path = '/productRequests/' + this.reqKey + '/payProof';
            this.$.doc.ref.set({
              path: this.$.payProofTask.path,
              downloadUrl: url,
            });
            this.reqKey = null;
          }.bind(this));
        }
      }

      getInventoryQuantity(prodKey) {
        for (var key in this.stockData) {
          if (key == prodKey) {
            return this.stockData[key];
          }
        }
        return 0;
      }

      getTotalQuantity(prodKey) {
        for (var key in this.productsData) {
          if (key == prodKey) {
            try{ var val = this.productsData[key]['qty']['total']; } catch(err){}
            return (val == undefined? 0:val);
          }
        }
        return 0;
      }

      getFreeQuantity(prodKey) {
        for (var key in this.productsData) {
          if (key == prodKey) {
            try{ var val = this.productsData[key]['qty']['free']; } catch(err){}
            return (val == undefined? 0:val);
          }
        }
        return 0;
      }

      isAdmin(privilege){
        return (privilege == "Admin");
      }

      promptToast(element) {
        Polymer.dom(document.body).appendChild(element);
        element.center();
        element.refit();
        element.open();
      }

      getPrices(change, prodKey, level) {
        if (prodKey != undefined
            && change.base[prodKey] != undefined
            && change.base[prodKey]['prices'] != undefined){
          return change.base[prodKey]['prices'][level];
        }
      }

      getPayable(change, prodKey, level, quantity) {
        if (prodKey != undefined
            && change.base[prodKey] != undefined
            && change.base[prodKey]['prices'] != undefined
            && !isNaN(quantity)){
          return (change.base[prodKey]['prices'][level] * quantity).toFixed(2);
        }
      }
    }
    window.customElements.define(StoreView.is, StoreView);
  </script>
</dom-module>
