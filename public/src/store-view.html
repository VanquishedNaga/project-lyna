<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Condensed">
<link rel="import" href="shared-styles.html">
<link rel="import" href="inventory-view.html">

<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

<dom-module id="store-view">
  <template>
    <firebase-auth
      id="auth"
      app-name="absolute-reborn"
      provider="google"
      signed-in="{{signedIn}}"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="user"
      path = "/users/[[user.uid]]"
      data = "{{usersData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="user"
      path = "/users/[[uplineUid]]"
      data = "{{uplineUsersData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="user"
      path = "/products"
      data = "{{productsData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-document
      id="user"
      path = "/products/[[prodKey]]"
      data = "{{productsData2}}"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="absolute-reborn"
      path="/products"
      data="{{prodItems}}">
    </firebase-query>

    <firebase-query
      id="products-list"
      app-name="absolute-reborn"
      path="/products"
      data="{{productsList}}">
    </firebase-query>

    <firebase-storage-ref
      id="storage"
      app-name="absolute-reborn"
      path="/products"
      metadata="{{metadata}}"
      storage-uri="{{gsUri}}"
      download-url="{{downloadUrl}}"
      force-unique>
    </firebase-storage-ref>

    <firebase-storage-upload-task
      id="task"
      app-name="absolute-reborn"
      task="[[task]]"
      bytes-transferred="{{bytesTransferred}}"
      total-bytes="{{totalBytes}}"
      state="{{state}}"
      download-url="{{downloadUrl}}"
      metadata="{{metadata}}"
      path="{{path}}">
    </firebase-storage-upload-task>

    <style include="shared-styles">
      :host {
        display: block;
      }

      .product-card {
        /*background: linear-gradient(white, #b2ebf2);*/
        width: 75%;
        /*min-width: 250px;*/
        padding: 16px;
        margin: 16px;
        display: inline-block;
        /*background: gray;*/
        font-family: 'Roboto Condensed', sans-serif;

      }

       .horizontal {
        @apply(--layout-horizontal);
      }

      @media only screen and (max-width: 600px) {
          #productImage{
          min-width:150px;
        }
      }
    </style>

    <app-header-layout>
      <app-header slot="header" condenses shadow fixed effect="waterfall">
        <app-toolbar class="header">
          <slot name="drawer-toggle"></slot>
          <div>Store</div>
        </app-toolbar>
        <app-toolbar class="tabs-bar" hidden$="{{!wideLayout}}" sticky>
          <paper-tabs id="tabs" selected="{{selected}}" attr-for-selected="name">
            <template is="dom-repeat" items="{{tabItems}}">
              <paper-tab name$="{{item}}">{{item}}</paper-tab>
            </template>
          </paper-tabs>
        </app-toolbar>
      </app-header>

      <iron-pages selected="{{selected}}" attr-for-selected="page-name">
        <div page-name="Product">
          <app-toolbar hidden$="{{!wideLayout}}">
            <paper-button on-tap="addProduct" disabled="[[disabled]]">
              <iron-icon icon="add-circle-outline"></iron-icon>
              <span>Add product</span>
            </paper-button>
          </app-toolbar>

          <template is="dom-repeat" items="{{prodItems}}">
            <paper-card class="product-card horizontal">
              <iron-image
              src="[[item.images.downloadUrl]]"
              id="productImage"
              style="
              width:250px;
              min-width: 250px;
              height:auto;
              top: 0;
              bottom: 0;
              left: 0;
              display: inline-block;"
              sizing="cover">
            </iron-image>

            <span style="display: inline;">
              <div class="card-content">
                <div>[[item.name]]</div>
                <p>Description: </p>
                <div>[[item.description]]</div>
              </div>
            </span>
            <div style="float: right;" >
              <paper-icon-button icon="icons:add-circle" on-tap="restock"></paper-icon-button>
              <paper-icon-button icon="icons:create" on-tap="editProd"></paper-icon-button>
              <paper-icon-button icon="icons:delete" on-tap="delProd"></paper-icon-button>
            </div>
          </paper-card>
        </template>
      </div>
      <inventory-view page-name="Inventory"></inventory-view>
      <div>Page 3</div>
    </iron-pages>
  </app-header-layout>

    <!-- Dialog to add new product -->
    <paper-dialog
      id="addprod"
      modal
      on-iron-overlay-closed="closeThis">
      <h2>Add product</h2>
      <paper-input always-float-label required
        error-message="Field required!"
        id="new-prod-name"
        label="Product Name">
      </paper-input>
      <paper-dialog-scrollable >
        <paper-textarea always-float-label id="new-prod-desc" label="Product Description" value={{value}}></paper-textarea>
      </paper-dialog-scrollable >
      <paper-input type="file" id="prod-pic" accept="image/jpeg"></paper-input>
      <div class="buttons">
        <!-- <paper-button on-tap="uploadProdPic" >Upload photo</paper-button> -->
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="saveNewProd" autofocus>Save</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="restockprod" on-iron-overlay-closed="closeThis" modal>
      <h2>Restock Request</h2>
      <paper-dialog-scrollable>
        <!-- <p>Product: [[productsData2.name]]</p> -->
        <p>Upline: [[uplineUsersData.name]]</p>
        <p>Current Stock Left Quantity: //TODO: Update quantity</p>
        <span style="display: inline;">
          <paper-dropdown-menu label="Select product" id="productMenu">
          <paper-listbox id="productList" slot="dropdown-content" attr-for-selected="key" selected="{{prodKey}}">
            <template is="dom-repeat" items="{{productsList}}">
              <paper-item key="[[item.$key]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-input always-float-label required auto-validate
          type="number"
          min="1"
          error-message="Field required!"
          id="prod-quantity"
          label="Product Quantity">
        </paper-input>
        </span>
        </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="submitProdRequest">Submit Request</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class StoreView extends Polymer.Element {
      static get is() { return 'store-view'; }
      static get properties() {
        return {
          productName: String,
          usersData: Object,
          uplineUsersData: Object,
          productsData: Object,
          productsList: Array,
          selected: {type: String, value: 'Product'},
          prodKey: String,
          tabItems: {
            type: Array,
            value: function() {
              return ['Product', 'Inventory'];
            }
          },

          prodItems: {
            type: Array
          },

          state: {
            type: Object,
            observer: 'stateChanged'
          },

          value: {
            type: Object,
            observer: 'valueChanged'
          },
        };
      }

      ready() {
        super.ready();
        console.log("StoreView ready.");

        this.dlAddProduct = this.shadowRoot.querySelector('#addprod');
        this.dlRestockProduct = this.shadowRoot.querySelector('#restockprod')
        this.prodName = this.shadowRoot.querySelector('#new-prod-name');
        this.prodDesc = this.shadowRoot.querySelector('#new-prod-desc');
        this.prodPic = this.shadowRoot.querySelector('#prod-pic');
        this.prodQuan = this.shadowRoot.querySelector('#prod-quantity');
        this.pages = this.shadowRoot.querySelector('#iron-pages');

        // init to null to solve error
        this.prodKey = null;
        this.prodName.value = null;
        this.prodDesc.value = null;
        //this.prodQuan.value = null;
      }

      valueChanged() {
        this.dlAddProduct.notifyResize();
      }

      addProduct() {
        Polymer.dom(document.body).appendChild(this.dlAddProduct);

        this.dlAddProduct.open();
      }

      restockProd(){
        Polymer.dom(document.body).appendChild(this.dlRestockProduct);

        this.dlRestockProduct.open();
      }

      closeThis() {
        //Polymer.dom(document.body).removeChild(this.dlAddProduct);
        this.prodName.value = null;
        this.prodDesc.value = null;
        this.prodName.invalid = false;
        this.prodPic.value = null;
      }

      saveNewProd() {
        var valid = this.prodName.validate();

        if (valid)
        {
          if (this.prodKey){
            this.$.doc.path = '/products/' + this.prodKey;
            this.$.doc.ref.update({
              name: this.prodName.value,
              description: this.prodDesc.value
            });
            console.log(this.prodName.value + ' edited.');
          }
          else{
            this.$.doc.path = '/products';

            // Save the key.
            this.prodKey = this.$.doc.ref.push({
              name: this.prodName.value,
              description: this.prodDesc.value,
            }).key;
            console.log(this.prodName.value + ' saved.');
            console.log('Key: ' + this.prodKey);
          }

          // Upload product pic.
          var file = this.prodPic.inputElement.inputElement.files[0];
          if (file){
            this.$.storage.path = '/products';
            this.$.task.task = this.$.storage.put(this.prodPic.inputElement.inputElement.files[0]);
          }
          else{
            this.prodKey = null;
          }

          // Close the dialog.
          this.dlAddProduct.close();
        }
      }

      delProd(e) {
        this.$.doc.path = '/products/'+ e.model.item.$key;

        if (e.model.item.images != null){
          // Delete product images.
          this.$.storage.path = '/' + e.model.item.images.path;
          this.$.storage.ref.delete();
        }

        // Remove product entry.
        this.$.doc.ref.remove();
        console.log(e.model.item.name + ' deleted from database.');
      }

      editProd(e) {
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.prodDesc.value = e.model.item.description || null;
        this.addProduct();
      }

      restock(e){
        this.prodKey = e.model.item.$key;
        this.prodName.value = e.model.item.name || null;
        this.uplineUid = this.usersData.upline;
        this.restockProd();
      }

      stateChanged() {
        console.log(this.$.task.state);
        if (this.$.task.state == 'success'){
          this.$.task.ref.getDownloadURL()
            .then(function(url){
              this.downloadUrl = url;
              console.log(this.downloadUrl);
               console.log("product key:" + this.prodKey);
              // Add image path to product entry.
              this.$.doc.path = '/products/' + this.prodKey + '/images';
              this.$.doc.ref.set({
                path: this.$.task.path,
                downloadUrl: this.downloadUrl,
              });
              console.log(this.$.task.path);
              this.prodKey = null;
            }.bind(this));
        }
      }

      submitProdRequest(){
        var valid = this.prodQuan.validate();

        if(valid){
          if(this.prodKey){
            this.$.doc.path = '/productRequests';
            this.$.doc.ref.push({
              productID: this.prodKey,
              quantity: this.prodQuan.value,
              requestor: this.user.uid,
              upline: this.uplineUid
            });
          }
          this.dlRestockProduct.close();
        }
      }
    }

    window.customElements.define(StoreView.is, StoreView);
  </script>
</dom-module>
