<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="org-view.html">

<dom-module id="people-view">
  <template>

    <firebase-query
      id="requestData"
      app-name="absolute-reborn"
      path="/users/[[user.uid]]/requests"
      data="{{requestList}}">
    </firebase-query>

    <firebase-query
      id="downline-list"
      app-name="absolute-reborn"
      path="/users/[[user.uid]]/downlines"
      data="{{downlineList}}">
    </firebase-query>

    <firebase-document
      id="users-list"
      app-name="absolute-reborn"
      path="/users"
      data="{{userList}}">
    </firebase-document>

    <firebase-document
      id="users-list"
      app-name="absolute-reborn"
      path="/users/[[user.uid]]/upline"
      data="{{uplineData}}">
    </firebase-document>

    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <style include="shared-styles">
      :host {
        display: block;
      }
      paper-icon-item paper-item-body {
        display: inline-block;
        width: 100%;
      }
      paper-icon-item paper-icon-button {
        color: green;
      }
      .expandInfo {
        background-color: var(--app-primary-color);
        color: white;
        border: solid thick white;
      }
    </style>

    <!-- Visible contents -->
    <app-header-layout>
      <app-header slot="header" condenses shadow fixed>
        <app-toolbar class="header">
          <slot name="drawer-toggle"></slot>
          <div>People</div>
        </app-toolbar>
        <app-toolbar class="tabs-bar" sticky>
          <paper-tabs selected="{{selected}}" attr-for-selected="name">
            <template is="dom-repeat" items="{{tabItems}}">
              <paper-tab name$="{{item}}">{{item}}</paper-tab>
            </template>
          </paper-tabs>
        </app-toolbar>
      </app-header>

      <iron-pages selected="[[selected]]" attr-for-selected="page-name">
        <div page-name="Requests" class="content">
          <div>You have [[requestList.length]] pending downline requests.</div>
          <paper-listbox id="request">
            <template is="dom-repeat" items="{{requestList}}">
              <paper-icon-item>
                <div class="avatar" slot="item-icon"
                style="background-image: url([[getUserInfo(userList.*, item.user, 'profilePic')]]);"></div>
                <paper-item-body two-line>
                  <div>[[getUserInfo(userList.*, item.user, 'name')]]</div>
                  <div secondary>Description here.</div>
                </paper-item-body>
                <paper-icon-button id="[[getBtnID('apr_', index)]]" icon="check" alt="Accept" on-tap="openApproveDialog">
                </paper-icon-button>
                <paper-tooltip for="[[getBtnID('apr_', index)]]" offset="0">Accept</paper-tooltip>
                <paper-icon-button id="[[getBtnID('rjt_', index)]]" icon="clear" alt="Reject" on-tap="openApproveDialog">
                </paper-icon-button>
                <paper-tooltip for="[[getBtnID('rjt_', index)]]" offset="0">Reject</paper-tooltip>
              </paper-icon-item>
            </template>
          </paper-listbox>
        </div>

        <div page-name="Line" class="content">
          <h1>Upline</h1>
          <paper-listbox>
            <paper-icon-item>
              <div class="avatar" slot="item-icon"
                style="background-image: url([[getUserInfo(userList.*, uplineData, 'profilePic')]]);"></div>
                <paper-item-body two-line>
                  <div>[[getUserInfo(userList.*, uplineData, 'name')]]</div>
                </paper-item-body>
              <div style="width: 20%;">[[getUserInfo(userList.*, item.$key, 'level')]]</div>
            </paper-icon-item>
          </paper-listbox>

          <h1>Downline</h1>
          <paper-listbox class="downlineList">
            <template is="dom-repeat" items="{{downlineList}}">
              <paper-icon-item>
                <div class="avatar" slot="item-icon"
                style="background-image: url([[getUserInfo(userList.*, item.$key, 'profilePic')]]);"></div>
                <div style="width: 30%;">[[getUserInfo(userList.*, item.$key, 'name')]]</div>
                <div style="width: 20%;">[[getUserInfo(userList.*, item.$key, 'level')]]</div>
              </paper-icon-item>
            </template>
          </paper-listbox>
        </div>

        <div page-name="Users" class="content">
          <template is="dom-if" if="[[isAdmin(userdata.privilege)]]">
            <paper-listbox>
              <template is="dom-repeat" items="{{toArray(userList.*)}}">
                <paper-icon-item on-tap="toggle">
                  <div class="avatar" slot="item-icon"
                  style="background-image: url([[getUserInfo(userList.*, item.key, 'profilePic')]]);"></div>
                  <paper-item-body two-line>
                    <div>[[getUserInfo(userList.*, item.key, 'name')]]</div>
                    <div secondary style="color: grey; font-size: 0.9em">[[getUserInfo(userList.*, item.key, 'status')]]</div>
                  </paper-item-body>
                  <iron-icon id$="icon[[index]]"" icon="expand-more"></iron-icon>
                </paper-icon-item>
                <iron-collapse id$="collapse[[index]]">
                  <div class="expandInfo">
                    <div>
                      <paper-button on-tap="openSuspendUserDialog" class="custom" hidden="[[!isUserApproved(userList.*, item.key)]]">
                        <iron-icon icon="pan-tool"></iron-icon>
                        <span>Suspend</span>
                      </paper-button>
                      <paper-button on-tap="openUnsuspendUserDialog" class="custom" hidden="[[!isUserSuspended(userList.*, item.key)]]">
                        <iron-icon icon="pan-tool"></iron-icon>
                        <span>Unsuspend</span>
                      </paper-button>
                      <paper-button on-tap="openPromoteAdminDialog" class="custom" hidden="[[isUserAdmin(userList.*, item.key)]]">
                        <iron-icon icon="arrow-upward"></iron-icon>
                        <span>Promote as admin</span>
                      </paper-button>
                      <paper-button on-tap="openDemoteAdminDialog" class="custom" hidden="[[!isUserAdmin(userList.*, item.key)]]">
                        <iron-icon icon="arrow-downward"></iron-icon>
                        <span>Demote admin</span>
                      </paper-button>
                      <paper-button on-tap="openEditDialog" class="custom">
                        <iron-icon icon="create"></iron-icon>
                        <span>Edit</span>
                      </paper-button>
                    </div>
                    <table width="100%" class="infoTable">
                      <tr>
                        <td class="tbLabel">Access</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'privilege')]]</td>
                      </tr>
                      <tr>
                        <td class="tbLabel">Level</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'level')]]</td>
                      </tr>
                      <tr>
                        <td class="tbLabel">Upline</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'upline')]]</td>
                      </tr>
                      <tr>
                        <td class="tbLabel">Email</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'email')]]</td>
                      </tr>
                      <tr>
                        <td class="tbLabel">Phone</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'phone')]]</td>
                      </tr>
                      <tr>
                        <td class="tbLabel">Address</td>
                        <td class="tbValue">[[getUserInfo(userList.*, item.key, 'address')]]</td>
                      </tr>
                    </table>
                  </div>
                </iron-collapse>
              </template>
            </paper-listbox>
          </template>
        </div>
        <div page-name="OrgChart" class="content">
          <org-view></org-view>
        </div>
      </iron-pages>
    </app-header-layout>

    <!-- To confirm accepting/rejecting a downline request -->
    <paper-dialog id="approveDialog" on-iron-overlay-closed="onDialogClosed" modal>
      <h2>[[getActionType(event, 1)]] Downline Request</h2>
      <p>Are you sure you want to [[getActionType(event, 0)]] the downline request from [[getUserInfo(userList.*, event.model.item.user, 'name')]]?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="suspendUserDialog" on-iron-overlay-closed="onSuspendUserDialogClosed" modal>
      <h2>Suspend User</h2>
      <p>Are you sure you want to suspend this user account?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Suspend</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="unsuspendUserDialog" on-iron-overlay-closed="onUnsuspendUserDialogClosed" modal>
      <h2>Unsuspend User</h2>
      <p>Are you sure you want to unsuspend this user account?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Unsuspend</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="promoteAdminDialog" on-iron-overlay-closed="onPromoteAdminDialogClosed" modal>
      <h2>Promote as Admin</h2>
      <p>Are you sure you want to promote this user as admin?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Promote</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="demoteAdminDialog" on-iron-overlay-closed="onDemoteAdminDialogClosed" modal>
      <h2>Demote Admin</h2>
      <p>Are you sure you want to demote this admin?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Demote</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="editDialog" on-iron-overlay-closed="onEditInfoClose" modal>
      <paper-dialog-scrollable>
        <div style="
          display: block;
          padding: 16px;
          width: 80%;
          margin: auto;">
          <h1 style="text-align: center;">Update Information</h1>
          <paper-input
            required
            error-message="Field required!"
            id="userName"
            label="Name"
            value="[[userData.name]]"
            always-float-label>
          </paper-input>
          <paper-input
            id="userLevel"
            label="Level"
            value="[[userData.level]]"
            always-float-label>
          </paper-input>
          <paper-input
            id="userEmail"
            label="Email"
            value="[[userData.email]]"
            always-float-label>
          </paper-input>
          <paper-input
            allowed-pattern="[0-9]"
            error-message="Invalid Field"
            id="userPhone"
            label="Phone"
            char-counter
            minlength="10"
            maxlength="11"
            value="[[userData.phone]]"
            always-float-label>
          </paper-input>
          <paper-input
            error-message="Field required!"
            id="userAddress"
            label="Address"
            value="[[userData.address]]"
            always-float-label>
          </paper-input>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="submitInfo">Submit</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class PeopleView extends Polymer.Element {
      static get is() { return 'people-view'; }
      static get properties() {
        return {
          requestList: Array,
          user: Object,
          userList: Object,
          event: Object,
          tabItems: {
            type: Array,
            value: function() {
              return ['Requests','Line'];
            }
          },
          selected: {type: String, value: 'Requests'},
          userdata: Object,
        };
      }
      static get observers() {
        return [
          'onPrivilegeChanged(userdata.privilege)'
        ]
      }

      ready() {
        super.ready();
        console.log("PeopleView ready.");
      }

      onPrivilegeChanged(privilege) {
        if (privilege == "Admin") {
          this.tabItems = ['Requests', 'Line', 'Users', 'OrgChart'];
        }
        else {
          this.tabItems = ['Requests', 'Line'];
          this.selected = 'Requests';
        }
      }

      getRequestName(change, user) {
        if (change.base[user] != undefined){
          return change.base[user]['name'];
        }
      }

      getUserInfo(change, user, data) {
        var retVal;
        if (change.base[user] != undefined) {
          retVal = change.base[user][data];
        }
        if (data == 'upline') {
          if (this.userList[change.base[user][data]] != undefined) {
            retVal = this.userList[change.base[user][data]]['name'];
          }
        }
        return retVal;
      }

      isUserApproved(change, user) {
        if (change.base[user] != undefined) {
          return (change.base[user]['status'] == 'Approved');
        }
      }

      isUserSuspended(change, user) {
        if (change.base[user] != undefined) {
          return (change.base[user]['status'] == 'Suspended');
        }
      }

      isUserAdmin(change, user) {
        if (change.base[user] != undefined) {
          return (change.base[user]['privilege'] == 'Admin');
        }
      }

      getBtnID(string, index) {
        return string + index;
      }

      getActionType(e, num) {
        if (e) {
          var retVal;
          if (e.target.id.indexOf("apr") >= 0){
            if (num) {
              retVal = 'Accept';
            }
            else {
              retVal = 'accept';
            }
          }
          else {
            if (num) {
              retVal = 'Reject';
            }
            else {
              retVal = 'reject';
            }
          }
          return retVal;
        }
      }

      openApproveDialog(e) {
        this.event = e;
        if (this.event.target.id.indexOf("apr") >= 0) {
          this.event.isAccept = true;
        }
        else {
          this.event.isAccept = false;
        }

        Polymer.dom(document.body).appendChild(this.$.approveDialog);
        this.$.approveDialog.open();
      }

      onDialogClosed() {
        if (!this.$.approveDialog.closingReason.canceled) {
          if (this.$.approveDialog.closingReason.confirmed) {
            if (this.event.isAccept) {
              this.processDownlineRequest(true);
            }
            else {
              this.processDownlineRequest(false);
            }
          }
        }
        this.event = null;
        Polymer.dom(document.body).removeChild(this.$.approveDialog);
      }

      openSuspendUserDialog(event) {
        this.event = event;
        Polymer.dom(document.body).appendChild(this.$.suspendUserDialog);
        this.$.suspendUserDialog.open();
      }

      onSuspendUserDialogClosed() {
        if (this.$.suspendUserDialog.closingReason.confirmed) {
          var uid = this.event.model.__data.item.key;
          this.$.doc.path = '/users/'+ uid;
          this.$.doc.ref.update({
            status: 'Suspended',
          });
        }
        this.event = null;
        Polymer.dom(document.body).removeChild(this.$.suspendUserDialog);
      }

      openUnsuspendUserDialog(event) {
        this.event = event;
        Polymer.dom(document.body).appendChild(this.$.unsuspendUserDialog);
        this.$.unsuspendUserDialog.open();
      }

      onUnsuspendUserDialogClosed() {
        if (this.$.unsuspendUserDialog.closingReason.confirmed) {
          var uid = this.event.model.__data.item.key;
          this.$.doc.path = '/users/'+ uid;
          this.$.doc.ref.update({
            status: 'Approved',
          });
        }
        this.event = null;
        Polymer.dom(document.body).removeChild(this.$.unsuspendUserDialog);
      }

      openPromoteAdminDialog(event) {
        this.event = event;
        Polymer.dom(document.body).appendChild(this.$.promoteAdminDialog);
        this.$.promoteAdminDialog.open();
      }

      onPromoteAdminDialogClosed() {
        if (this.$.promoteAdminDialog.closingReason.confirmed) {
          var uid = this.event.model.__data.item.key;
          this.$.doc.path = '/users/'+ uid;
          this.$.doc.ref.update({
            privilege: 'Admin',
          });
        }
        this.event = null;
        Polymer.dom(document.body).removeChild(this.$.promoteAdminDialog);
      }

      openDemoteAdminDialog(event) {
        this.event = event;
        Polymer.dom(document.body).appendChild(this.$.demoteAdminDialog);
        this.$.demoteAdminDialog.open();
      }

      onDemoteAdminDialogClosed() {
        if (this.$.demoteAdminDialog.closingReason.confirmed) {
          var uid = this.event.model.__data.item.key;
          this.$.doc.path = '/users/'+ uid;
          this.$.doc.ref.update({
            privilege: 'User',
          });
        }
        this.event = null;
        Polymer.dom(document.body).removeChild(this.$.demoteAdminDialog);
      }

      processDownlineRequest(isAccept) {
        var status;
        if (isAccept) {
          status = "Approved";

          // Update downline list.
          this.$.doc.path = '/users/' + this.user.uid + '/downlines';
          this.$.doc.ref.update({
            [this.event.model.item.user]: true,
          });
        }
        else {
          status = "Rejected";
        }

        // Change requester's status.
        this.$.doc.path = '/users/'+ this.event.model.item.user;
        this.$.doc.ref.update({
          status: status,
        });

        // Remove request.
        this.$.doc.path = '/users/'+ this.user.uid + '/requests/' + this.event.model.item.$key;
        this.$.doc.ref.remove();
      }

      toArray(input) {
        var obj = input.base;
        return Object.keys(obj).map(function(key) {
          return {
            key: key,
            value: obj[key]
          };
        });
      }

      isAdmin(privilege){
        return (privilege == "Admin");
      }

      toggle(event) {
        var collapseElem = this.shadowRoot.querySelector('#collapse'+event.model.__data.index);
        collapseElem.toggle();
        var iconElem = this.shadowRoot.querySelector('#icon'+event.model.__data.index);
        if (collapseElem.opened) {
          Polymer.dom(iconElem).setAttribute('icon', 'expand-less');
        }
        else {
          Polymer.dom(iconElem).setAttribute('icon', 'expand-more');
        }
      }

      openEditDialog(event) {
        this.event = event;

        this.$.userName.value = this.userList[this.event.model.__data.item.key]['name'] || null;
        this.$.userLevel.value = this.userList[this.event.model.__data.item.key]['level'] || null;
        this.$.userEmail.value = this.userList[this.event.model.__data.item.key]['email'] || null;
        this.$.userPhone.value = this.userList[this.event.model.__data.item.key]['phone'] || null;
        this.$.userAddress.value = this.userList[this.event.model.__data.item.key]['address'] || null;

        Polymer.dom(document.body).appendChild(this.$.editDialog);
        this.$.editDialog.open();
      }

      submitInfo(e) {
        // Check all inputs are valid, add new fields here.
        var valid = this.$.userName.validate();
        valid = this.$.userPhone.validate() && valid;
        valid = this.$.userAddress.validate() && valid;

        if (valid) {
          this.$.doc.path = '/users/' + this.event.model.__data.item.key;
          this.$.doc.ref.update({
            name: this.$.userName.value,
            level: this.$.userLevel.value,
            email: this.$.userEmail.value,
            phone: this.$.userPhone.value,
            address: this.$.userAddress.value
          });

          this.$.editDialog.close();
        }
      }

      onEditInfoClose() {
        this.event = null;

        this.$.userName.value = null;
        this.$.userLevel.value = null;
        this.$.userEmail.value = null;
        this.$.userPhone.value = null;
        this.$.userAddress.value = null;

        this.$.userName.invalid = false;
        this.$.userPhone.invalid = false;
        this.$.userAddress.invalid = false;

        Polymer.dom(document.body).removeChild(this.$.editDialog);
      }
    }

    window.customElements.define(PeopleView.is, PeopleView);
  </script>
</dom-module>
