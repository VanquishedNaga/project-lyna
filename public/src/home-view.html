<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Condensed">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<script src="../bower_components/strftime/strftime-min.js"></script>

<dom-module id="home-view">
  <template>
    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="messageList"
      path = "/messages"
      data = "{{messageList}}"
      app-name="absolute-reborn">
    </firebase-query>

    <firebase-document
      id="users"
      path = "/users/[[user.uid]]"
      data = "{{usersData}}"
      app-name="absolute-reborn">
    </firebase-document>

    <style include="shared-styles">
      app-header {
        color: #fff;
        background-color: #000;
      }

      app-toolbar {
        height: var(--app-toolbar-height);
      }

      .noti-card {
        width: 80%;
        min-width: 282px;
        margin: 16px;
        font-family: 'Roboto Condensed', sans-serif;
        margin-left: auto;
        margin-right: auto;
      }

      .noti-header {
        background-color: var(--app-primary-color);
        color: white;
        display: flex;
        flex-wrap: wrap;
      }

      span.header {
        padding: 8px;
        font-size: 1.1em;
      }

      .noti-desc {
        overflow: auto;
        white-space: pre-line;
      }

      .prod-content {
        clear: right;
        display: flex;
        flex-wrap: wrap;
      }

      .noti-info {
        min-width: 250px;
        word-break: break-word;
        hyphens: manual;
        vertical-align: top;
        margin: 16px;
        max-height: 250px;
        display: flex;
        flex-direction: column;
        flex: 1 1 250px;
      }

      .noti-act {
        float: right;
        margin-left: auto;
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      [condensed-title] {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-size: 350px;
        /*background-size: calc(var(--app-toolbar-height) * 2);*/
        background-image: url('../images/small_banner.png');
        background-repeat: no-repeat;
        background-position: center center;

        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 5px;
      }

      [main-title] {
        position: absolute;
        /*top: -110px;*/
        top: calc(0px - 2 * var(--app-toolbar-height));
        bottom: 0;
        left: 0;
        right: 0;
        background-image: url('../images/banner.png');
        background-repeat: no-repeat;
        background-position: center 25%;
        background-size: 900px;
        -webkit-transform-origin: center top !important;
        transform-origin: center top !important;
        z-index: -1;  /*not to cover drawer toggle button*/

        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 15px;
      }
    </style>
    <app-header-layout>
      <app-header slot="header" condenses shadow fixed effects="resize-title waterfall" >
        <app-toolbar>
          <slot name="drawer-toggle"></slot>
          <div condensed-title></div>
        </app-toolbar>
        <app-toolbar></app-toolbar>
        <app-toolbar>
          <div main-title></div>
        </app-toolbar>
      </app-header>

      <template is="dom-if" if="[[isAdmin(usersData.privilege)]]">
        <app-toolbar>
          <paper-button on-tap="addNotice" class="custom">
            <iron-icon icon="add-circle-outline"></iron-icon>
            <span>Add notice</span>
          </paper-button>
        </app-toolbar>
      </template>

      <template is="dom-repeat" items="{{messageList}}">
        <paper-card class="noti-card horizontal">
          <div style="width: 100%;">
            <div class="noti-header">
              <span class="header">
                <iron-icon icon="icons:speaker-notes"></iron-icon>
                Notice Board
              </span>
              <div class="noti-act">
                <paper-icon-button hidden$="[[!isAdmin(usersData.privilege)]]" icon="icons:create" on-tap="editNotice"></paper-icon-button>
                <paper-icon-button hidden$="[[!isAdmin(usersData.privilege)]]" disabled$="[[isEmpty(item.*)]]" icon="icons:delete" on-tap="delNotice"></paper-icon-button>
              </div>
            </div>
            <div class="card-content noti-info">
              <template is="dom-if" if="[[!isEmpty(item.*)]]" restamp>
                <div class="noti-desc">[[item.message]]</div>
                <br>
                <span style="display: inline;">
                  <span style="font-weight: bold;">Posted on </span>
                  <span>[[_formatEpochDate(item.time)]] [[_formatEpochTime(item.time)]]</span>
                </span>
              </template>
              <template is="dom-if" if="[[isEmpty(item.*)]]" restamp>
                No announcement.
              </template>
            </div>
          </div>
        </paper-card>
      </template>
    </app-header-layout>

    <paper-dialog id="updateNoticeDialog" on-iron-overlay-closed="onEditDialogClose" modal>
      <h2>Notice Board Message</h2>
      <paper-dialog-scrollable>
        <paper-textarea
          required
          always-float-label
          id="messageDesc"
          label="Notice Board Message">
        </paper-textarea>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="updateMessage">Submit</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="deleteNotiDialog" modal>
      <p>Are you sure you want to delete this message?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button autofocus on-tap="deleteMessage">Yes
        </paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    class HomeView extends Polymer.Element {
      static get is() { return 'home-view'; }
      static get properties() {
        return {
          usersData: Object,
          user: Object,
          event: Object,
          msgKey: Object,
        };
      }

      ready() {
        super.ready();
        console.log("HomeView ready.");
      }

      addNotice() {
        Polymer.dom(document.body).appendChild(this.$.updateNoticeDialog);
        this.$.updateNoticeDialog.open();
      }

      editNotice(e) {
        this.msgKey = e.model.item.$key;
        this.$.messageDesc.value = e.model.item.message;
        Polymer.dom(document.body).appendChild(this.$.updateNoticeDialog);
        this.$.updateNoticeDialog.open();
      }

      updateMessage() {
        var valid = this.$.messageDesc.validate();

        if(valid) {
          if (this.msgKey) {
            this.$.doc.path = '/messages/' + this.msgKey;
            this.$.doc.ref.update({
              message: this.$.messageDesc.value
            });
            this.$.updateNoticeDialog.close();
          }
          else {
            // new message
            this.$.doc.path = '/messages';
            this.$.doc.ref.push({
              message: this.$.messageDesc.value,
              time: {".sv":"timestamp"}
            });
            this.$.updateNoticeDialog.close();
          }
        }
      }

      delNotice(e) {
        this.msgKey = e.model.item.$key;
        Polymer.dom(document.body).appendChild(this.$.deleteNotiDialog);
        this.$.deleteNotiDialog.open();
      }

      deleteMessage() {
        this.$.doc.path = '/messages/' + this.msgKey;
        this.msgKey = null;
        this.$.doc.ref.remove();
        this.$.deleteNotiDialog.close();
        Polymer.dom(document.body).removeChild(this.$.deleteNotiDialog);
      }

      _formatEpochDate(eTS) {
        return strftime('%D', new Date(eTS));
      }

      _formatEpochTime(eTS) {
        return strftime('%I:%M %P', new Date(eTS));
      }

      isAdmin(privilege){
        return (privilege == "Admin");
      }

      isEmpty(change) {
        return (change.base['message'] == undefined);
      }

      onEditDialogClose() {
        this.$.messageDesc.value = null;
        this.$.messageDesc.invalid = false;
        this.msgKey = null;
        Polymer.dom(document.body).removeChild(this.$.updateNoticeDialog);
      }
    }

    window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
