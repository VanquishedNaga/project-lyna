<!--
@license
Copyright (c) 2018 Phoon Yin Jiat & Yap Jian Ying. All rights reserved.
-->
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Condensed">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="notice-view.html">

<script src="../bower_components/strftime/strftime-min.js"></script>

<dom-module id="home-view">
  <template>
    <firebase-document
      id="doc"
      app-name="absolute-reborn">
    </firebase-document>

    <firebase-query
      id="messageList"
      path = "/messages"
      data = "{{messageList}}"
      app-name="absolute-reborn">
    </firebase-query>

    <firebase-storage-ref
      id="storage"
      app-name="absolute-reborn"
      path="/messages"
      force-unique>
    </firebase-storage-ref>

    <style include="shared-styles">
      :root {
        --radius: 5px;
      }
      app-header {
        color: #fff;
        background-color: #000;
      }

      app-toolbar {
        height: var(--app-toolbar-height);
      }

      [condensed-title] {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-size: 350px;
        /*background-size: calc(var(--app-toolbar-height) * 2);*/
        background-image: url('../images/small_banner.png');
        background-repeat: no-repeat;
        background-position: center center;

        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 5px;
      }

      [main-title] {
        position: absolute;
        top: calc(0px - 2 * var(--app-toolbar-height));
        bottom: 0;
        left: 0;
        right: 0;
        background-image: url('../images/banner.png');
        background-repeat: no-repeat;
        background-position: center 25%;
        background-size: 900px;
        -webkit-transform-origin: center top !important;
        transform-origin: center top !important;
        z-index: -1;  /*not to cover drawer toggle button*/

        /* The difference in font size is used to calculate the scale of the title in the transition. */
        font-size: 15px;
      }
    </style>
    <app-header-layout>
      <app-header slot="header" condenses shadow fixed effects="resize-title waterfall" >
        <app-toolbar>
          <slot name="drawer-toggle"></slot>
          <div condensed-title></div>
        </app-toolbar>
        <app-toolbar></app-toolbar>
        <app-toolbar>
          <div main-title></div>
        </app-toolbar>
      </app-header>

      <template is="dom-if" if="[[isAdmin(userdata.privilege)]]">
        <app-toolbar>
          <paper-button on-tap="addNotice" class="custom">
            <iron-icon icon="add-circle-outline"></iron-icon>
            <span>Add notice</span>
          </paper-button>
        </app-toolbar>
      </template>

      <template is="dom-repeat" items="{{messageList}}">
        <notice-view
          messagekey="[[item.$key]]"
          user="[[user]]"
          userdata="[[userdata]]">
        </notice-view>
      </template>
    </app-header-layout>

    <paper-dialog id="updateNoticeDialog" on-iron-overlay-closed="onEditDialogClose" modal>
      <h2>Notice Board Message</h2>
      <paper-toggle-button id="eventToggle" >Event</paper-toggle-button>
      <paper-dialog-scrollable>
        <paper-textarea
          required
          error-message="Field required!"
          always-float-label
          id="messageDesc"
          label="Notice Board Message">
        </paper-textarea>
      </paper-dialog-scrollable>
      <paper-input type="file" id="noticePic" accept="image/jpeg"></paper-input>
      <div class="buttons">
        <paper-button id="addNoticeCancelButton" dialog-dismiss>Cancel</paper-button>
        <paper-button id="addNoticeButton" autofocus on-tap="postNewMessage">Submit</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="successToast" class="good" text="Action successful!"> </paper-toast>
    <paper-toast id="failToast" class="bad" text="Action failed! Please try again."> </paper-toast>
  </template>

  <script>
    class HomeView extends Polymer.Element {
      static get is() { return 'home-view'; }
      static get properties() {
        return {
          userdata: Object,
          user: Object,
          event: Object,
          msgKey: Object,
          messagekey: Object,
          messageList: Array,
        };
      }

      ready() {
        super.ready();
        console.log("HomeView ready.");
      }

      addNotice() {
        Polymer.dom(document.body).appendChild(this.$.updateNoticeDialog);
        this.$.updateNoticeDialog.open();
      }

      postNewMessage() {
        var valid = this.$.messageDesc.validate();
        if(valid) {
          // New message
          this.$.doc.path = '/messages';
          this.$.doc.ref.push({
            message: this.$.messageDesc.value,
            time: {".sv":"timestamp"},
            event: this.$.eventToggle.checked
          }).then(function(snapshot) {
            this.msgKey = snapshot.key;
            this.uploadNoticeBoardImage();
          }.bind(this)).catch(function(error) {
            console.log(error);
            this.$.updateNoticeDialog.close();
          }.bind(this));
        }
      }

      uploadNoticeBoardImage() {
        // Upload notice board pic.
        var file = this.$.noticePic.inputElement.inputElement.files[0];
        if (file){

          // Disable buttons to prevent exiting dialog before upload is done.
          this.$.addNoticeCancelButton.disabled = true;
          this.$.addNoticeButton.disabled = true;

          this.$.storage.path = '/messages';
          this.$.storage.put(file).then(function(snap) {
            // TODO: Delete old image if exist
            // Update product entry with image url
            this.$.doc.path = '/messages/' + this.msgKey + '/images';
            this.$.doc.ref.set({
              path: snap.metadata.fullPath,
              downloadUrl: snap.downloadURL,
            });

            this.$.updateNoticeDialog.close();
            Polymer.dom(document.body).appendChild(this.$.successToast);
            this.$.successToast.open();
          }.bind(this))
          // Failed to upload
          .catch(function(error) {
            console.log(error);
            this.$.updateNoticeDialog.close();
            Polymer.dom(document.body).appendChild(this.$.failToast);
            this.$.failToast.open();
          }.bind(this));
        }
        else{
          this.$.updateNoticeDialog.close();
        }
      }

      _formatEpochDate(eTS) {
        return strftime('%D', new Date(eTS));
      }

      _formatEpochTime(eTS) {
        return strftime('%I:%M %P', new Date(eTS));
      }

      isAdmin(privilege){
        return (privilege == "Admin");
      }

      onDialogClose() {
        this.$.messageDesc.value = null;
        this.$.messageDesc.invalid = false;
        this.$.eventToggle.checked = false;
        this.$.eventToggle.disabled = false;
        this.$.noticePic.value = null;
        this.$.addNoticeButton.disabled = false;
        this.$.addNoticeCancelButton.disabled = false;
      }

      onEditDialogClose() {
        this.onDialogClose();
        Polymer.dom(document.body).removeChild(this.$.updateNoticeDialog);
      }
    }

    window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
